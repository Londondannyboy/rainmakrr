---
/**
 * Global Deal Map Visualization
 *
 * Interactive map showing placement agent locations and deal flows
 * Uses Leaflet for reliable, lightweight mapping
 */
import SEO from '../../components/SEO.astro';
import Navigation from '../../components/Navigation.astro';
import { sql } from '../../lib/db';

// Fetch placement agents with headquarters
const agents = await sql`
  SELECT
    id, name, slug,
    COALESCE(display_name, name) as display_name,
    headquarters,
    payload->>'aum' as aum,
    payload->>'industry' as industry,
    global_rank
  FROM companies
  WHERE company_type = 'placement_agent'
    AND status = 'published'
    AND headquarters IS NOT NULL
  ORDER BY global_rank ASC NULLS LAST
  LIMIT 100
`;

// City coordinates mapping
const cityCoords: Record<string, [number, number]> = {
  'london': [51.5074, -0.1276],
  'new york': [40.7128, -74.006],
  'hong kong': [22.3193, 114.1694],
  'singapore': [1.3521, 103.8198],
  'tokyo': [35.6895, 139.6917],
  'paris': [48.8566, 2.3522],
  'frankfurt': [50.1109, 8.6821],
  'sydney': [-33.8688, 151.2093],
  'dubai': [25.2048, 55.2708],
  'mumbai': [19.0760, 72.8777],
  'shanghai': [31.2304, 121.4737],
  'boston': [42.3601, -71.0589],
  'chicago': [41.8781, -87.6298],
  'los angeles': [34.0522, -118.2437],
  'san francisco': [37.7749, -122.4194],
  'toronto': [43.6532, -79.3832],
  'zurich': [47.3769, 8.5417],
  'amsterdam': [52.3676, 4.9041],
  'edinburgh': [55.9533, -3.1883],
  'manchester': [53.4808, -2.2426],
  'seoul': [37.5665, 126.9780],
  'beijing': [39.9042, 116.4074],
  'melbourne': [-37.8136, 144.9631],
  'cape town': [-33.9249, 18.4241],
  'sao paulo': [-23.5505, -46.6333]
};

// Process agents into map points
const agentPoints = agents.map((agent: any) => {
  const hq = (agent.headquarters || '').toLowerCase();
  let coords: [number, number] = [51.5074, -0.1276]; // Default London

  for (const [city, coord] of Object.entries(cityCoords)) {
    if (hq.includes(city)) {
      coords = coord;
      break;
    }
  }

  // Add small random offset to prevent overlap
  coords = [
    coords[0] + (Math.random() - 0.5) * 0.3,
    coords[1] + (Math.random() - 0.5) * 0.3
  ];

  return {
    id: agent.id,
    name: agent.display_name,
    slug: agent.slug,
    headquarters: agent.headquarters,
    lat: coords[0],
    lng: coords[1],
    rank: agent.global_rank
  };
});

// Regional stats
const regionStats = {
  'North America': agents.filter((a: any) => {
    const hq = (a.headquarters || '').toLowerCase();
    return hq.includes('us') || hq.includes('new york') || hq.includes('boston') ||
           hq.includes('chicago') || hq.includes('canada') || hq.includes('toronto');
  }).length,
  'Europe': agents.filter((a: any) => {
    const hq = (a.headquarters || '').toLowerCase();
    return hq.includes('uk') || hq.includes('london') || hq.includes('paris') ||
           hq.includes('frankfurt') || hq.includes('zurich') || hq.includes('amsterdam');
  }).length,
  'Asia Pacific': agents.filter((a: any) => {
    const hq = (a.headquarters || '').toLowerCase();
    return hq.includes('hong kong') || hq.includes('singapore') || hq.includes('tokyo') ||
           hq.includes('sydney') || hq.includes('mumbai') || hq.includes('shanghai');
  }).length
};
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <SEO
    title="Global Deal Map | Placement Agent Locations"
    description="Interactive map showing placement agent locations worldwide. Visualize the global distribution of PE fundraising advisors."
  />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #fff;
      color: #1a1a1a;
      line-height: 1.6;
    }

    .page-container {
      min-height: 100vh;
      padding-top: 80px;
    }

    /* Header */
    .header-section {
      padding: 32px 20px 24px;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .header-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #dbeafe;
      border: 1px solid #93c5fd;
      padding: 6px 14px;
      border-radius: 100px;
      font-size: 11px;
      color: #1d4ed8;
      margin-bottom: 12px;
    }

    .header-badge .beta {
      background: linear-gradient(135deg, #f59e0b, #ef4444);
      font-size: 8px;
      padding: 2px 5px;
      border-radius: 3px;
      font-weight: 700;
      color: #fff;
    }

    h1 {
      font-size: 2rem;
      font-weight: 800;
      color: #1a1a1a;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #6b7280;
      font-size: 1rem;
    }

    /* Stats Bar */
    .stats-bar {
      display: flex;
      justify-content: center;
      gap: 40px;
      padding: 20px;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 800;
      color: #1d4ed8;
    }

    .stat-label {
      font-size: 11px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Map Container */
    .map-section {
      display: grid;
      grid-template-columns: 240px 1fr;
      min-height: calc(100vh - 250px);
    }

    /* Sidebar */
    .sidebar {
      padding: 20px;
      border-right: 1px solid #e5e7eb;
      background: #fafafa;
    }

    .sidebar-title {
      font-size: 11px;
      font-weight: 700;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 0;
      font-size: 13px;
      color: #374151;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .region-list {
      margin-top: 20px;
    }

    .region-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .region-name {
      color: #374151;
    }

    .region-count {
      font-weight: 700;
      color: #1d4ed8;
    }

    /* Map */
    #map {
      width: 100%;
      height: 100%;
      min-height: 500px;
    }

    /* Custom marker styles */
    .custom-marker {
      background: #4f46e5;
      border: 2px solid #fff;
      border-radius: 50%;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .top-marker {
      background: #10b981;
    }

    /* Popup styles */
    .leaflet-popup-content-wrapper {
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .popup-content {
      padding: 4px;
    }

    .popup-title {
      font-weight: 700;
      font-size: 14px;
      color: #1a1a1a;
      margin-bottom: 4px;
    }

    .popup-subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .popup-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: #4f46e5;
      text-decoration: none;
    }

    .popup-link:hover {
      text-decoration: underline;
    }

    /* Controls */
    .map-controls {
      padding: 16px 20px;
      background: #fff;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .control-btn {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 8px 14px;
      color: #374151;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .control-btn:hover {
      border-color: #4f46e5;
      color: #4f46e5;
    }

    .provenance {
      font-size: 11px;
      color: #9ca3af;
    }

    /* Mobile */
    @media (max-width: 768px) {
      .map-section {
        grid-template-columns: 1fr;
      }
      .sidebar {
        display: none;
      }
      .stats-bar {
        gap: 20px;
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <Navigation />

  <div class="page-container">
    <div class="header-section">
      <div class="header-badge">
        <svg style="width: 14px; height: 14px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064"></path>
        </svg>
        Global Map
        <span class="beta">BETA</span>
      </div>
      <h1>Placement Agent Locations</h1>
      <p class="subtitle">Global distribution of PE fundraising advisors</p>
    </div>

    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-value">{agents.length}</div>
        <div class="stat-label">Total Agents</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">{regionStats['North America']}</div>
        <div class="stat-label">North America</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">{regionStats['Europe']}</div>
        <div class="stat-label">Europe</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">{regionStats['Asia Pacific']}</div>
        <div class="stat-label">Asia Pacific</div>
      </div>
    </div>

    <div class="map-section">
      <aside class="sidebar">
        <div class="sidebar-title">Legend</div>
        <div class="legend-item">
          <div class="legend-dot" style="background: #10b981;"></div>
          <span>Top 10 Agents</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background: #4f46e5;"></div>
          <span>Other Agents</span>
        </div>

        <div class="region-list">
          <div class="sidebar-title">By Region</div>
          <div class="region-item">
            <span class="region-name">North America</span>
            <span class="region-count">{regionStats['North America']}</span>
          </div>
          <div class="region-item">
            <span class="region-name">Europe</span>
            <span class="region-count">{regionStats['Europe']}</span>
          </div>
          <div class="region-item">
            <span class="region-name">Asia Pacific</span>
            <span class="region-count">{regionStats['Asia Pacific']}</span>
          </div>
        </div>

        <div style="margin-top: 24px;">
          <div class="sidebar-title">Quick Links</div>
          <a href="/ecosystem" class="control-btn" style="display: block; text-align: center; margin-top: 8px; text-decoration: none;">
            Agent Universe
          </a>
          <a href="/visualizations/capital-flow" class="control-btn" style="display: block; text-align: center; margin-top: 8px; text-decoration: none;">
            Capital Flow
          </a>
        </div>
      </aside>

      <div id="map"></div>
    </div>

    <div class="map-controls">
      <div>
        <button class="control-btn" id="reset-view">Reset View</button>
        <button class="control-btn" id="export-png" style="margin-left: 8px;">Export PNG</button>
      </div>
      <div class="provenance">
        Data: Placement Quest Directory | Updated: {new Date().toLocaleDateString()}
      </div>
    </div>
  </div>

  <script define:vars={{ agentPoints }}>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize map centered on Atlantic (between US and Europe)
      const map = L.map('map').setView([35, -20], 2);

      // Add light tile layer
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
      }).addTo(map);

      // Add markers for each agent
      agentPoints.forEach(agent => {
        const isTop10 = agent.rank && agent.rank <= 10;
        const size = isTop10 ? 14 : 10;
        const color = isTop10 ? '#10b981' : '#4f46e5';

        const marker = L.circleMarker([agent.lat, agent.lng], {
          radius: size / 2,
          fillColor: color,
          color: '#fff',
          weight: 2,
          fillOpacity: 0.9
        }).addTo(map);

        // Create popup content
        const popupContent = `
          <div class="popup-content">
            <div class="popup-title">${agent.name}</div>
            <div class="popup-subtitle">${agent.headquarters || 'Global'}</div>
            <a href="/private-equity-placement-agents-list/${agent.slug}" class="popup-link">
              View Profile â†’
            </a>
          </div>
        `;

        marker.bindPopup(popupContent);
      });

      // Reset view button
      document.getElementById('reset-view')?.addEventListener('click', () => {
        map.setView([35, -20], 2);
      });

      // Export PNG (basic screenshot via canvas)
      document.getElementById('export-png')?.addEventListener('click', () => {
        alert('To export: Use your browser\'s screenshot tool or right-click > Save image');
      });
    });
  </script>
</body>
</html>
