---
/**
 * Placement Quest Article Template
 * =================================
 *
 * DATA SOURCE: Neon PostgreSQL (articles table, app='placement')
 * GENERATED BY: content-worker ArticleCreationWorkflow
 *
 * REQUIRED NEON FIELDS:
 * - video_playback_id: Mux playback ID
 * - video_narrative: JSON with acts, thumbnails
 * - payload: JSON with four_act_content, faq, callouts, comparison, timeline, stat_highlight, sources
 * - content: HTML article body
 * - meta_description: SEO excerpt
 *
 * 4-ACT FRAMEWORK:
 * - 12 seconds total = 4 acts √ó 3 seconds each
 * - Act timestamps: 0-3s, 3-6s, 6-9s, 9-12s
 * - Each section gets a bounded animated video loop from its act
 *
 * MUX VIDEO INTEGRATION:
 * - Use HLS streaming for bounded chapter loops
 * - Thumbnails for poster images and visual breaks
 *
 * FINANCE-THEMED DESIGN:
 * - Professional blue (#2563eb) primary color
 * - Emerald green (#10b981) for growth/money themes
 * - Clean, trust-inspiring corporate aesthetic
 */
import { sql } from '../lib/db';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/');
}

// PRIORITY 1: Check if this is a company profile and redirect
const companyCheck = await sql`
  SELECT slug FROM companies
  WHERE slug = ${slug}
    AND company_type = 'placement_agent'
  LIMIT 1
`;

if (companyCheck.length > 0) {
  return Astro.redirect(`/private-equity-placement-agents-list/${slug}`);
}

// PRIORITY 2: Fetch article with 4-act structured data
const articleResult = await sql`
  SELECT
    a.id,
    a.title,
    a.content,
    a.meta_description as excerpt,
    a.slug,
    a.published_at,
    a.created_at,
    a.article_angle,
    a.word_count,
    a.video_url,
    a.video_playback_id,
    a.featured_asset_url,
    a.hero_asset_url,
    a.video_narrative,
    a.payload
  FROM articles a
  WHERE a.slug = ${slug}
    AND a.app = 'placement'
  LIMIT 1
`;

const article = articleResult[0];

if (!article) {
  return Astro.redirect('/');
}

// Fetch related articles
const relatedResult = await sql`
  SELECT slug, title, meta_description, video_playback_id, article_angle
  FROM articles
  WHERE app = 'placement'
    AND slug != ${slug}
    AND published_at IS NOT NULL
  ORDER BY created_at DESC
  LIMIT 3
`;
const relatedArticles = relatedResult || [];

// Parse video_narrative (4-act video data)
let videoData: any = null;
try {
  videoData = typeof article.video_narrative === 'string'
    ? JSON.parse(article.video_narrative)
    : article.video_narrative;
} catch (e) {
  console.error('Failed to parse video_narrative:', e);
}

// Parse payload for structured content
let fourActContent: any[] = [];
let faq: any[] = [];
let callouts: any[] = [];
let statHighlight: any = null;
let comparison: any = null;
let timeline: any[] = [];
let sources: any[] = [];

try {
  const payload = typeof article.payload === 'string'
    ? JSON.parse(article.payload)
    : article.payload;
  if (payload) {
    fourActContent = payload.four_act_content || payload.sections || [];
    faq = payload.faq || [];
    callouts = payload.callouts || [];
    statHighlight = payload.stat_highlight || null;
    comparison = payload.comparison || null;
    timeline = payload.timeline || [];
    sources = payload.structured_sources || payload.sources || [];
    // Also check for video_narrative inside payload
    if (!videoData && payload.video_narrative) {
      videoData = payload.video_narrative;
    }
  }
} catch (e) {
  console.error('Failed to parse payload:', e);
}

// Get playback ID from video_narrative or direct field
const playbackId = videoData?.playback_id || article.video_playback_id;

// Act timestamps for bounded video loops (4 acts √ó 3 seconds)
const actTimestamps = [
  { start: 0, end: 3, mid: 1.5, label: 'Act 1' },
  { start: 3, end: 6, mid: 4.5, label: 'Act 2' },
  { start: 6, end: 9, mid: 7.5, label: 'Act 3' },
  { start: 9, end: 12, mid: 10.5, label: 'Act 4' }
];

// Helper functions for Mux URLs
function getMuxThumbnail(time: number, width: number = 800) {
  if (!playbackId) return '';
  return `https://image.mux.com/${playbackId}/thumbnail.jpg?time=${time}&width=${width}`;
}

function getMuxStream() {
  if (!playbackId) return '';
  return `https://stream.mux.com/${playbackId}.m3u8`;
}

// Finance-themed icons mapping
const financeIcons: Record<string, string> = {
  'breakthrough': 'üöÄ',
  'regulatory': '‚öñÔ∏è',
  'strategy': 'üìä',
  'playbook': 'üìã',
  'wealth': 'üí∞',
  'opportunity': 'üíé',
  'future': 'üîÆ',
  'growth': 'üìà',
  'investment': 'üíµ',
  'legal': '‚öñÔ∏è',
  'default': 'üíº'
};

function getFinanceIcon(title: string): string {
  const lower = title.toLowerCase();
  for (const [keyword, icon] of Object.entries(financeIcons)) {
    if (lower.includes(keyword)) return icon;
  }
  return financeIcons.default;
}

// Split content by H2 headers to match with fourActContent sections
function splitContentBySections(html: string): string[] {
  if (!html) return [];
  const sections = html.split(/<h2[^>]*>/i);
  return sections.map((s, i) => {
    if (i === 0) return s;
    return '<h2>' + s;
  }).filter(s => s.trim());
}

const contentSections = splitContentBySections(article.content || '');

// Clean up excerpt
let excerpt = article.excerpt || '';
if (excerpt && !excerpt.endsWith('.') && !excerpt.endsWith('!') && !excerpt.endsWith('?')) {
  const lastSentence = Math.max(excerpt.lastIndexOf('.'), excerpt.lastIndexOf('?'), excerpt.lastIndexOf('!'));
  if (lastSentence > excerpt.length * 0.5) {
    excerpt = excerpt.substring(0, lastSentence + 1);
  } else {
    excerpt = excerpt.trim() + '...';
  }
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{article.title} - Placement Quest</title>
  <meta name="description" content={excerpt || article.title}>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://unpkg.com/@mux/mux-player"></script>
  <style>
    /* Finance-themed variables */
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --primary-light: #dbeafe;
      --accent: #10b981;
      --accent-dark: #059669;
      --accent-light: #d1fae5;
      --gold: #f59e0b;
      --gold-light: #fef3c7;
    }

    .thumbnail-overlay {
      position: relative;
      overflow: hidden;
    }
    .thumbnail-overlay video,
    .thumbnail-overlay img {
      transition: transform 0.3s ease;
    }
    .thumbnail-overlay:hover video,
    .thumbnail-overlay:hover img {
      transform: scale(1.02);
    }
    .thumbnail-gradient {
      background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 40%, transparent 100%);
    }
    .brand-badge {
      background: rgba(37, 99, 235, 0.9);
      backdrop-filter: blur(4px);
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .chapter-marker {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .chapter-marker:hover {
      transform: scale(1.05);
    }

    /* Prose styling - professional finance theme */
    .prose h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
      margin-top: 2rem;
      margin-bottom: 1rem;
    }
    .prose p {
      color: #374151;
      line-height: 1.85;
      margin-bottom: 1.5rem;
    }
    .prose p + p {
      margin-top: 1.5rem;
    }
    .prose strong, .prose b {
      color: #1e40af;
      font-weight: 700;
      background: linear-gradient(120deg, #dbeafe 0%, #bfdbfe 100%);
      padding: 0 0.25rem;
      border-radius: 0.125rem;
    }
    .prose a {
      color: #2563eb;
      text-decoration: underline;
      text-underline-offset: 2px;
      font-weight: 500;
      transition: color 0.2s;
    }
    .prose a:hover {
      color: #1d4ed8;
    }
    .prose ul, .prose ol {
      margin-bottom: 1.75rem;
      padding-left: 1.5rem;
    }
    .prose li {
      margin-bottom: 0.75rem;
      color: #374151;
      line-height: 1.7;
    }
    .prose li strong {
      display: inline;
    }

    /* Pull quote - finance style */
    .pull-quote {
      position: relative;
      border-left: 4px solid #2563eb;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 50%, #fff 100%);
      padding: 2rem 2.5rem;
      margin: 2.5rem 0;
      font-size: 1.35rem;
      font-style: italic;
      color: #1f2937;
      border-radius: 0 1rem 1rem 0;
      box-shadow: 0 4px 20px rgba(37, 99, 235, 0.15);
    }
    .pull-quote::before {
      content: '"';
      position: absolute;
      top: -0.5rem;
      left: 1rem;
      font-size: 4rem;
      color: #2563eb;
      opacity: 0.3;
      font-family: Georgia, serif;
      line-height: 1;
    }

    /* Callout card - pro tip blue, warning amber */
    .callout-card {
      border-radius: 1rem;
      padding: 1.5rem 2rem;
      margin: 2rem 0;
    }
    .callout-card.pro-tip {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border: 2px solid #2563eb;
      box-shadow: 0 8px 25px rgba(37, 99, 235, 0.2);
    }
    .callout-card.pro-tip h4 {
      color: #1e40af;
    }
    .callout-card.pro-tip p {
      color: #1e3a8a;
    }
    .callout-card.warning {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px solid #f59e0b;
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.2);
    }
    .callout-card.warning h4 {
      color: #92400e;
    }
    .callout-card.warning p {
      color: #78350f;
    }

    /* Comparison cards - finance professional */
    .comparison-card {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 1px solid #e2e8f0;
      transition: all 0.2s ease;
    }
    .comparison-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    .comparison-card.featured {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border-color: #10b981;
    }

    /* Episodic color bar */
    .episodic-bar {
      display: flex;
      height: 4px;
      background: #1f2937;
    }
    .episodic-bar span {
      flex: 1;
      transition: opacity 0.3s;
    }
    .episodic-bar span:hover {
      opacity: 0.7;
    }

    /* Hook statement - finance style */
    .hook-statement {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
      border-left: 4px solid #2563eb;
      padding-left: 1.5rem;
      margin: 2rem 0;
      line-height: 1.4;
    }
    .hook-statement .highlight {
      background: linear-gradient(120deg, #dbeafe 0%, #bfdbfe 100%);
      padding: 0.125rem 0.5rem;
      border-radius: 0.25rem;
    }

    /* Styled bullet lists as cards - finance theme */
    .prose ul {
      list-style: none;
      padding-left: 0;
      display: grid;
      gap: 0.75rem;
      margin: 1.5rem 0;
    }
    .prose ul li {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 1px solid #e2e8f0;
      border-left: 3px solid #2563eb;
      padding: 1rem 1.25rem;
      border-radius: 0 0.5rem 0.5rem 0;
      margin-bottom: 0;
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }
    .prose ul li::before {
      content: '‚Üí';
      color: #2563eb;
      font-weight: bold;
      flex-shrink: 0;
    }

    /* Stat card - finance metrics */
    .stat-card {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border: 1px solid #10b981;
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      font-size: 0.9rem;
      font-weight: 500;
      color: #065f46;
    }
    .stat-card .value {
      font-size: 1.1rem;
      font-weight: 700;
    }

    /* Responsive paragraph spacing */
    .prose p {
      margin-bottom: 1.75rem !important;
    }
    .prose p br {
      display: block;
      content: '';
      margin-top: 1rem;
    }

    @media (max-width: 768px) {
      .prose p {
        font-size: 1rem;
        line-height: 2;
        margin-bottom: 2rem !important;
      }
      .prose ul li {
        padding: 0.875rem 1rem;
      }
      .hook-statement {
        font-size: 1.25rem;
      }
    }
  </style>
</head>
<body class="bg-white">
  <!-- Navigation -->
  <nav class="bg-white border-b border-gray-100 sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
      <a href="/" class="text-2xl font-bold text-blue-600">Placement</a>
      <div class="flex items-center gap-6">
        <a href="/" class="text-gray-600 hover:text-blue-600 font-medium">Home</a>
        <a href="/private-equity-placement-agent-news" class="text-gray-600 hover:text-blue-600 font-medium">News</a>
        <a href="/private-equity-placement-agents-list" class="text-gray-600 hover:text-blue-600 font-medium">Directory</a>
      </div>
    </div>
  </nav>

  <!-- Hero Section with Video -->
  {playbackId ? (
    <header class="relative bg-gray-900">
      <div class="max-w-6xl mx-auto">
        <mux-player
          playback-id={playbackId}
          accent-color="#2563eb"
          autoplay="muted"
          loop
          class="w-full aspect-video"
        />
      </div>
      <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-8">
        <div class="max-w-4xl mx-auto">
          {article.article_angle && (
            <span class="text-blue-400 text-sm font-semibold uppercase tracking-wider">{article.article_angle}</span>
          )}
          <h1 class="text-4xl md:text-5xl font-bold text-white mt-2 mb-4">{article.title}</h1>
          {excerpt && (
            <p class="text-xl text-gray-200">{excerpt}</p>
          )}
        </div>
      </div>
    </header>
  ) : (
    <header class="bg-gradient-to-br from-blue-50 to-indigo-50 py-16">
      <div class="max-w-4xl mx-auto px-4">
        {article.article_angle && (
          <span class="text-blue-600 text-sm font-semibold uppercase tracking-wider">{article.article_angle}</span>
        )}
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mt-2 mb-4">{article.title}</h1>
        {excerpt && (
          <p class="text-xl text-gray-600">{excerpt}</p>
        )}
      </div>
    </header>
  )}

  <!-- Episodic Color Bar -->
  {playbackId && fourActContent.length >= 4 && (
    <div class="episodic-bar">
      <span class="bg-blue-500" onclick="seekTo(0)"></span>
      <span class="bg-indigo-500" onclick="seekTo(3)"></span>
      <span class="bg-emerald-500" onclick="seekTo(6)"></span>
      <span class="bg-teal-500" onclick="seekTo(9)"></span>
    </div>
  )}

  <!-- Chapter Timeline with Progress Bar -->
  {playbackId && fourActContent.length >= 4 && (
    <div class="bg-gray-900 py-4">
      <div class="max-w-4xl mx-auto px-4">
        <div class="flex items-center gap-2">
          <span class="text-gray-500 text-xs uppercase tracking-wider mr-2">Chapters</span>
          <div class="flex-1 flex items-center gap-1">
            {fourActContent.slice(0, 4).map((section, i) => {
              const colors = ['blue', 'indigo', 'emerald', 'teal'];
              const color = colors[i] || 'gray';
              const chapterLabel = section.video_title || section.title?.split(':')[0]?.substring(0, 20) || `Part ${i + 1}`;
              return (
                <button onclick={`seekTo(${i * 3})`} class="chapter-marker flex-1 group">
                  <div class={`h-1 bg-${color}-500/60 rounded-full group-hover:bg-${color}-400`}></div>
                  <span class="text-xs text-gray-400 mt-1 block truncate">{chapterLabel}</span>
                </button>
              );
            })}
          </div>
        </div>
      </div>
    </div>
  )}

  <script>
    function seekTo(time) {
      const player = document.querySelector('mux-player');
      if (player) player.currentTime = time;
    }
  </script>

  <main class="max-w-4xl mx-auto px-4 py-12">
    <!-- Preamble (content before first H2) -->
    {contentSections[0] && !contentSections[0].startsWith('<h2') && (
      <div class="prose prose-lg max-w-none mb-8">
        <div set:html={contentSections[0]} />
      </div>
    )}

    <!-- Hook Statement - Key insight opener -->
    {fourActContent[0]?.factoid && (
      <div class="hook-statement">
        <span class="highlight">{fourActContent[0].factoid}</span>
      </div>
    )}

    <!-- 4-Act Ticker Tape - HLS Video Chapter Navigation -->
    {playbackId && fourActContent.length >= 4 && (
      <div class="bg-gray-900 -mx-4 md:-mx-8 lg:-mx-16 px-4 md:px-8 lg:px-16 py-8 my-12 rounded-none md:rounded-2xl">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 max-w-5xl mx-auto">
          {fourActContent.slice(0, 4).map((section, i) => {
            const actTime = actTimestamps[i];
            const actTitle = section.video_title || section.title?.split(':')[0] || `Part ${i + 1}`;
            const icon = getFinanceIcon(section.title || '');
            return (
              <button onclick={`seekTo(${actTime.start})`} class="bg-gray-800 rounded-lg overflow-hidden text-left hover:bg-gray-700 transition group">
                <video
                  class="ticker-video w-full aspect-video object-cover"
                  muted
                  playsinline
                  loop
                  poster={getMuxThumbnail(actTime.mid, 480)}
                  data-hls={getMuxStream()}
                  data-start={actTime.start}
                  data-end={actTime.end}
                ></video>
                <div class="p-3">
                  <h3 class="font-semibold text-white text-sm flex items-center gap-2">
                    <span>{icon}</span>
                    {actTitle}
                  </h3>
                  <p class="text-xs text-gray-400 mt-1 line-clamp-2">{section.factoid || `${actTime.start}-${actTime.end}s`}</p>
                </div>
              </button>
            );
          })}
        </div>
      </div>
    )}

    <!-- Video Progress Divider -->
    {playbackId && (
      <div class="my-12 flex items-center justify-center gap-3 text-xs text-gray-400 font-mono">
        <span class="w-8 h-px bg-gradient-to-r from-transparent to-gray-300"></span>
        <span class="text-blue-500">0s</span>
        <span class="w-12 h-px bg-blue-300/50"></span>
        <span class="text-indigo-500">3s</span>
        <span class="w-12 h-px bg-indigo-300/50"></span>
        <span class="text-emerald-500">6s</span>
        <span class="w-12 h-px bg-emerald-300/50"></span>
        <span class="text-teal-500">9s</span>
        <span class="w-12 h-px bg-teal-300/50"></span>
        <span class="text-teal-600">12s</span>
        <span class="w-8 h-px bg-gradient-to-l from-transparent to-gray-300"></span>
      </div>
    )}

    <!-- 4-Act Sections -->
    {fourActContent.slice(0, 4).map((section, i) => {
      const actTime = actTimestamps[i];
      const sectionContent = contentSections.find(c => c.includes(section.title)) || '';
      const calloutForSection = callouts.find(c => c.placement === `after_section_${i + 1}`);
      const showTimeline = i === 0 && timeline.length > 0;
      const showRelated = i === 1 && relatedArticles.length > 0;
      const showStoryline = i === 2 && playbackId;
      const useTranslucentBg = i === 3;
      const icon = getFinanceIcon(section.title || '');

      return (
        <section class={`mb-16 ${useTranslucentBg ? 'relative bg-gradient-to-br from-blue-50/80 to-indigo-50/60 -mx-4 md:-mx-8 px-4 md:px-8 py-8 rounded-2xl' : ''}`}>
          {/* Translucent video background for final section */}
          {useTranslucentBg && playbackId && (
            <div class="absolute inset-0 rounded-2xl overflow-hidden -z-10">
              <img src={getMuxThumbnail(10, 1600)} alt="" class="w-full h-full object-cover opacity-[0.12] blur-[1px]" />
              <div class="absolute inset-0 bg-gradient-to-br from-blue-50/40 via-white/50 to-indigo-50/40"></div>
            </div>
          )}

          <!-- Section Header with HLS Video -->
          {playbackId && (
            <div class="thumbnail-overlay rounded-xl mb-6">
              <video
                class="section-video w-full aspect-[21/9] object-cover rounded-xl"
                muted
                playsinline
                loop
                poster={getMuxThumbnail(actTime.mid, 800)}
                data-hls={getMuxStream()}
                data-start={actTime.start}
                data-end={actTime.end}
              ></video>
              <div class="absolute inset-0 thumbnail-gradient rounded-xl pointer-events-none"></div>
              <div class="absolute top-3 right-3">
                <span class="brand-badge text-white/90">Placement Quest</span>
              </div>
              <div class="absolute bottom-4 left-4 right-4">
                <h2 class="text-xl md:text-2xl font-bold text-white drop-shadow-lg flex items-center gap-2">
                  <span class="text-2xl">{icon}</span>
                  {section.title}
                </h2>
                {section.factoid && (
                  <p class="text-white/80 text-sm mt-1 drop-shadow">{section.factoid}</p>
                )}
              </div>
            </div>
          )}

          <!-- Section Content -->
          {sectionContent ? (
            <div class="prose prose-lg max-w-none" set:html={sectionContent} />
          ) : (
            <div class="prose prose-lg max-w-none">
              <h2 class="flex items-center gap-2">
                <span>{icon}</span>
                {section.title}
              </h2>
            </div>
          )}

          <!-- Pull Quote (mid-section text breaker) -->
          {i === 0 && section.factoid && (
            <div class="pull-quote">
              "{section.factoid}"
            </div>
          )}

          <!-- Callout after section (if any) -->
          {calloutForSection && (
            <div class={`my-8 callout-card ${calloutForSection.type === 'warning' ? 'warning' : 'pro-tip'}`}>
              <div class="flex flex-col md:flex-row gap-6">
                {playbackId && (
                  <div class="md:w-1/3">
                    <img src={getMuxThumbnail(actTime.mid - 1, 600)} alt="" class="w-full h-48 md:h-full object-cover rounded-lg" />
                  </div>
                )}
                <div class={`${playbackId ? 'md:w-2/3' : 'w-full'}`}>
                  <h4 class="text-lg font-bold mb-2 flex items-center gap-2">
                    {calloutForSection.type === 'pro_tip' ? 'üí°' : '‚ö†Ô∏è'}
                    {calloutForSection.title}
                  </h4>
                  <p class="text-base leading-relaxed">{calloutForSection.content}</p>
                </div>
              </div>
            </div>
          )}

          <!-- Timeline (after section 1) -->
          {showTimeline && (
            <div class="my-12">
              <h3 class="text-lg font-bold text-gray-900 mb-6 flex items-center gap-2">
                <span>üìÖ</span> Key Milestones
              </h3>
              <div class="relative">
                <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gradient-to-b from-blue-500 via-blue-400 to-blue-300"></div>
                <div class="space-y-6">
                  {timeline.slice(0, 4).map((event, ti) => (
                    <div class="flex items-start gap-4 pl-4">
                      <div class="w-3 h-3 bg-blue-500 rounded-full mt-1.5 -ml-[7px] ring-4 ring-white"></div>
                      <div class="flex-1 bg-gray-50 rounded-lg p-4 border border-gray-100">
                        <span class="text-blue-600 text-xs font-semibold">{event.date}</span>
                        <h4 class="font-bold text-gray-900">{event.title}</h4>
                        <p class="text-sm text-gray-600">{event.description}</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          <!-- Related Articles (after section 2) -->
          {showRelated && (
            <div class="my-12 py-8 border-t border-b border-gray-100">
              <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Related Analysis</h3>
              <div class="grid md:grid-cols-3 gap-4">
                {relatedArticles.map((related, ri) => {
                  const relatedThumb = related.video_playback_id
                    ? `https://image.mux.com/${related.video_playback_id}/thumbnail.jpg?time=${actTimestamps[ri % 4].mid}&width=400`
                    : null;
                  return (
                    <a href={`/${related.slug}`} class="group block bg-gray-50 rounded-lg overflow-hidden hover:bg-gray-100 transition border border-gray-100">
                      {relatedThumb && (
                        <img src={relatedThumb} alt="" class="w-full h-24 object-cover opacity-80 group-hover:opacity-100 transition" />
                      )}
                      <div class="p-3">
                        <p class="font-medium text-gray-900 text-sm line-clamp-2 group-hover:text-blue-600 transition">{related.title}</p>
                      </div>
                    </a>
                  );
                })}
              </div>
            </div>
          )}

          <!-- 2x2 Storyline HLS Video Grid (after section 3) -->
          {showStoryline && (
            <div class="bg-gray-900 -mx-4 md:-mx-8 lg:-mx-16 px-4 md:px-8 lg:px-16 py-8 my-12 rounded-none md:rounded-2xl">
              <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4 text-center">The Story So Far</h3>
              <div class="grid grid-cols-2 gap-4 max-w-3xl mx-auto">
                {fourActContent.slice(0, 4).map((act, ai) => {
                  const actT = actTimestamps[ai];
                  const actIcon = getFinanceIcon(act.title || '');
                  return (
                    <div class="bg-gray-800 rounded-lg overflow-hidden">
                      <div class="relative">
                        <video
                          class="storyline-video w-full aspect-video object-cover"
                          muted
                          playsinline
                          loop
                          poster={getMuxThumbnail(actT.mid, 480)}
                          data-hls={getMuxStream()}
                          data-start={actT.start}
                          data-end={actT.end}
                        ></video>
                        <div class="absolute top-2 left-2 bg-black/70 px-2 py-1 rounded text-xs text-white font-medium flex items-center gap-1">
                          <span>{actIcon}</span>
                          {act.video_title || act.title?.split(':')[0] || `Part ${ai + 1}`}
                        </div>
                      </div>
                      <div class="p-3">
                        <p class="text-xs text-gray-400 line-clamp-2">{act.factoid}</p>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          <!-- Progress divider between sections -->
          {i < 3 && playbackId && (
            <div class="my-10 flex items-center justify-center gap-2 text-[10px] text-gray-300 font-mono">
              {actTimestamps.map((t, ti) => (
                <>
                  <span class={ti <= i ? 'text-blue-500' : 'text-gray-300'}>{t.start}s</span>
                  {ti < 3 && <span class={`w-8 h-px ${ti <= i ? 'bg-blue-400' : 'bg-gray-200'}`}></span>}
                </>
              ))}
              <span class={i >= 3 ? 'text-blue-500' : 'text-gray-300'}>12s</span>
            </div>
          )}
        </section>
      );
    })}

    <!-- Comparison Section -->
    {comparison && comparison.items && comparison.items.length > 0 && (
      <section class="mb-16">
        {playbackId && (
          <div class="thumbnail-overlay rounded-xl mb-6">
            <img src={getMuxThumbnail(6, 800)} alt="" class="w-full aspect-[21/9] object-cover rounded-xl" />
            <div class="absolute inset-0 thumbnail-gradient rounded-xl"></div>
            <div class="absolute bottom-4 left-6">
              <h2 class="text-2xl md:text-3xl font-bold text-white drop-shadow-lg flex items-center gap-2">
                <span>üìä</span> {comparison.title || 'Compare Your Options'}
              </h2>
            </div>
          </div>
        )}

        <div class="grid md:grid-cols-2 gap-4">
          {comparison.items.map((item, i) => {
            const isFeatured = i === 1; // PE-backed is the featured option
            return (
              <div class={`comparison-card rounded-xl p-5 ${isFeatured ? 'featured' : ''}`}>
                <div class="flex items-start gap-4">
                  <span class="text-4xl">{isFeatured ? 'üìà' : 'üèõÔ∏è'}</span>
                  <div class="flex-1">
                    <h3 class={`font-bold ${isFeatured ? 'text-xl text-emerald-800' : 'text-lg text-gray-900'}`}>{item.name}</h3>
                    <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
                      {Object.entries(item).filter(([k]) => k !== 'name').map(([key, value]) => (
                        <div>
                          <span class="text-gray-500 text-xs uppercase tracking-wider">{key.replace(/col\d/, 'Feature')}</span>
                          <p class={`font-medium ${isFeatured ? 'text-emerald-700' : 'text-gray-900'}`}>{value}</p>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </section>
    )}

    <!-- Stat Highlight -->
    {statHighlight && (
      <section class="mb-16 -mx-4 md:-mx-8 lg:-mx-16">
        <div class="relative py-16 px-8 overflow-hidden">
          {playbackId && (
            <div class="absolute inset-0">
              <img src={getMuxThumbnail(10, 1600)} alt="" class="w-full h-full object-cover opacity-[0.1]" />
              <div class="absolute inset-0 bg-gradient-to-r from-blue-50 via-white/90 to-blue-50"></div>
            </div>
          )}
          <div class="relative max-w-3xl mx-auto text-center">
            <span class="text-blue-600 text-sm font-semibold uppercase tracking-wider">üí∞ Key Insight</span>
            <p class="text-3xl md:text-4xl font-bold text-gray-900 mt-4 mb-6" set:html={statHighlight.headline} />
            {statHighlight.stats && (
              <div class="flex justify-center gap-8 mt-8">
                {statHighlight.stats.map(stat => (
                  <div class="text-center">
                    <div class="text-4xl font-bold text-blue-600">{stat.value}</div>
                    <div class="text-sm text-gray-500 mt-1">{stat.label}</div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </section>
    )}

    <!-- FAQ Section -->
    {faq && faq.length > 0 && (
      <section class="mb-16">
        <h2 class="text-3xl font-bold text-gray-900 mb-8 flex items-center gap-2">
          <span>‚ùì</span> Frequently Asked Questions
        </h2>
        <div class="grid md:grid-cols-2 gap-6">
          {faq.map((item, i) => {
            const thumbTime = actTimestamps[i % 4]?.mid || 1.5;
            return (
              <div class="bg-gray-50 rounded-xl overflow-hidden border border-gray-100">
                {playbackId && (
                  <img src={getMuxThumbnail(thumbTime, 400)} alt="" class="w-full h-32 object-cover opacity-60" />
                )}
                <div class={`p-6 ${playbackId ? '-mt-8' : ''} relative`}>
                  <div class="bg-white rounded-lg shadow-lg p-4">
                    <h3 class="font-bold text-gray-900 mb-2">{item.q}</h3>
                    <p class="text-gray-600 text-sm">{item.a}</p>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </section>
    )}

    <!-- Sources Section -->
    {sources && sources.length > 0 && (
      <section class="relative rounded-xl overflow-hidden mb-12">
        {playbackId && (
          <div class="absolute inset-0">
            <img src={getMuxThumbnail(10.5, 800)} alt="" class="w-full h-full object-cover opacity-10" />
            <div class="absolute inset-0 bg-gradient-to-br from-gray-50 via-white/90 to-gray-50"></div>
          </div>
        )}
        <div class="relative p-8">
          <h3 class="font-semibold text-gray-900 mb-4 flex items-center gap-2">
            <span>üìö</span> Sources & References
          </h3>
          <div class="grid md:grid-cols-2 gap-4">
            {sources.map((source, i) => {
              const thumbTime = actTimestamps[i % 4]?.mid || 1.5;
              const isValidUrl = source.url && source.url.startsWith('http');
              return (
                <a href={isValidUrl ? source.url : '#'} target={isValidUrl ? "_blank" : "_self"} rel="noopener" class="flex items-center gap-3 p-3 bg-white/60 rounded-lg hover:bg-white transition border border-gray-100">
                  {playbackId && (
                    <img src={getMuxThumbnail(thumbTime, 400)} alt="" class="w-12 h-12 object-cover rounded" />
                  )}
                  <div>
                    <p class="text-sm font-medium text-gray-900">{source.name}</p>
                    {source.description && (
                      <p class="text-xs text-gray-500">{source.description}</p>
                    )}
                  </div>
                </a>
              );
            })}
          </div>
        </div>
      </section>
    )}

    <!-- Article Footer -->
    <footer class="pt-8 border-t">
      <div class="flex items-center gap-4">
        {playbackId && (
          <img src={getMuxThumbnail(10.5, 800)} alt="" class="w-16 h-16 object-cover rounded-full border-2 border-blue-200" />
        )}
        <div>
          <p class="text-sm font-medium text-gray-900">Placement Quest Editorial Team</p>
          <p class="text-xs text-gray-500">
            Published {new Date(article.published_at || article.created_at).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })} ‚Ä¢ {article.word_count} words
          </p>
        </div>
      </div>
      <div class="mt-6 flex flex-wrap gap-3">
        <a href="/" class="inline-flex items-center text-blue-600 hover:text-blue-800 font-medium">
          ‚Üê Back to Home
        </a>
        <a href="/private-equity-placement-agent-news" class="inline-flex items-center text-gray-500 hover:text-gray-700 font-medium">
          More News
        </a>
        <a href="/private-equity-placement-agents-list" class="inline-flex items-center text-gray-500 hover:text-gray-700 font-medium">
          Agent Directory
        </a>
      </div>
    </footer>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-900 text-white py-12 mt-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <p class="text-gray-400">¬© {new Date().getFullYear()} Placement Quest. All rights reserved.</p>
    </div>
  </footer>

  <!-- Auto-Bold Key Financial Facts Script -->
  <script>
    document.querySelectorAll('.prose p, .prose li').forEach(el => {
      let html = el.innerHTML;

      const patterns = [
        // Currency amounts ($2,500, ‚Ç¨1,000, ¬£500)
        /(?<![<>])([‚Ç¨$¬£]\d{1,3}(?:,\d{3})*(?:\.\d{2})?(?:\s*(?:per|\/)\s*(?:hour|month|year|annually))?)/g,
        // Percentages (50%, 92% approval)
        /(?<![<>])(\d{1,3}%\s*(?:approval|tax|rate|interest|discount|increase|decrease|shortfall|returns?)?)/gi,
        // Time periods (3 years, 6-8 weeks)
        /(?<![<>])(\d{1,2}(?:-\d{1,2})?\s*(?:years?|months?|weeks?|days?)\s*(?:max(?:imum)?|min(?:imum)?|total|consecutive)?)/gi,
        // Key numbers (150+ firms, 1,000 permits)
        /(?<![<>])(\d{1,3}(?:,\d{3})*\+?\s*(?:firms?|companies|lawyers?|partners?|permits?|deals?|transactions?))/gi,
        // Specific patterns (over 300 days, 2024, 2025)
        /(?<![<>])((?:in|since|by)\s*20\d{2})/gi,
      ];

      patterns.forEach(pattern => {
        html = html.replace(pattern, (match) => {
          if (match.includes('<') || match.includes('>')) return match;
          return `<strong>${match}</strong>`;
        });
      });

      if (html !== el.innerHTML) {
        el.innerHTML = html;
      }
    });
  </script>

  <!-- Sentence Spacing Enhancement -->
  <script>
    document.querySelectorAll('.prose p').forEach(p => {
      const text = p.innerHTML;
      const spaced = text.replace(/(\.)(\s+)([A-Z])/g, '$1<br><br>$3');
      if (spaced !== text) {
        p.innerHTML = spaced;
      }
    });
  </script>

  <!-- HLS Video Init Script - Chapter-bounded video loops -->
  <script is:inline>
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof Hls === 'undefined' || !Hls.isSupported()) {
        console.log('HLS not supported, falling back to poster images');
        return;
      }

      const videos = document.querySelectorAll('[data-hls]');
      const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      videos.forEach(function(video) {
        const hlsUrl = video.dataset.hls;
        const start = parseFloat(video.dataset.start) || 0;
        const end = parseFloat(video.dataset.end) || 3;

        if (!hlsUrl) return;

        const hls = new Hls();
        hls.loadSource(hlsUrl);
        hls.attachMedia(video);

        hls.on(Hls.Events.MANIFEST_PARSED, function() {
          video.currentTime = start;
        });

        // Loop within chapter bounds
        video.addEventListener('timeupdate', function() {
          if (video.currentTime >= end) {
            video.currentTime = start;
          }
        });

        // IntersectionObserver for play/pause on visibility
        if (!prefersReducedMotion) {
          const observer = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
              if (entry.isIntersecting && entry.intersectionRatio >= 0.3) {
                video.play().catch(function() {});
              } else {
                video.pause();
              }
            });
          }, { threshold: 0.3 });
          observer.observe(video);
        }
      });
    });
  </script>
</body>
</html>
