---
/**
 * PE Ecosystem Universe
 *
 * Full 3D visualization of the private equity ecosystem
 * Shows all companies, deals, relationships across sectors
 */
import { sql } from '../../lib/db';
import SEO from '../../components/SEO.astro';
import Navigation from '../../components/Navigation.astro';

// Fetch all companies for ecosystem view
const companies = await sql`
  SELECT
    id, name, slug, company_type,
    COALESCE(display_name, name) as display_name,
    headquarters, global_rank,
    payload->>'industry' as industry,
    payload->>'founded_year' as founded_year
  FROM companies
  WHERE status = 'published'
  ORDER BY
    CASE WHEN global_rank IS NOT NULL THEN 0 ELSE 1 END,
    global_rank ASC NULLS LAST,
    name ASC
  LIMIT 100
`;

// Fetch recent articles for deal nodes
const articles = await sql`
  SELECT id, title, slug, article_angle,
    payload->>'timeline' as timeline
  FROM articles
  WHERE app = 'placement' AND status = 'published'
  ORDER BY COALESCE(published_at, created_at) DESC
  LIMIT 50
`;

// Categorize companies by type/region
const sectors = {
  placement_agents: companies.filter((c: any) => c.company_type === 'placement_agent'),
  pe_firms: companies.filter((c: any) => c.company_type === 'pe_firm'),
  other: companies.filter((c: any) => !['placement_agent', 'pe_firm'].includes(c.company_type))
};
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <SEO
    title="Placement Universe | Interactive 3D Placement Agent Network"
    description="Explore the placement agent universe in interactive 3D. Visualize placement agents, PE firms, deals, and relationships across UK, US, and global markets."
  />

  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <script src="https://unpkg.com/3d-force-graph@1.79.0" defer></script>

  <style is:inline>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; overflow: hidden; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      color: #f1f5f9;
    }

    .universe-container {
      position: fixed;
      inset: 0;
      z-index: 1;
    }

    #universe-graph {
      width: 100%;
      height: 100%;
    }

    /* Overlay UI */
    .overlay {
      position: fixed;
      z-index: 100;
      pointer-events: none;
    }

    .overlay > * {
      pointer-events: auto;
    }

    /* Header */
    .header-overlay {
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
    }

    .header-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(99, 102, 241, 0.2);
      border: 1px solid rgba(99, 102, 241, 0.3);
      padding: 8px 16px;
      border-radius: 100px;
      font-size: 12px;
      color: #a5b4fc;
      margin-bottom: 12px;
    }

    .header-badge .beta {
      background: linear-gradient(135deg, #f59e0b, #ef4444);
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .header-title {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(to right, #fff, #a5b4fc, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
    }

    .header-subtitle {
      font-size: 1rem;
      color: #64748b;
    }

    /* Legend Panel */
    .legend-panel {
      top: 100px;
      left: 20px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(51, 65, 85, 0.5);
      border-radius: 12px;
      padding: 16px;
      max-width: 200px;
    }

    .legend-title {
      font-size: 12px;
      font-weight: 600;
      color: #94a3b8;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 0;
      font-size: 13px;
      color: #cbd5e1;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .legend-divider {
      height: 1px;
      background: rgba(51, 65, 85, 0.5);
      margin: 12px 0;
    }

    /* Sector Buttons */
    .sector-panel {
      top: 100px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sector-btn {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(51, 65, 85, 0.5);
      border-radius: 8px;
      padding: 12px 16px;
      color: #cbd5e1;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }

    .sector-btn:hover {
      border-color: rgba(99, 102, 241, 0.5);
      background: rgba(99, 102, 241, 0.1);
    }

    .sector-btn.active {
      border-color: #6366f1;
      background: rgba(99, 102, 241, 0.2);
      color: #fff;
    }

    .sector-btn small {
      display: block;
      font-size: 11px;
      color: #64748b;
      margin-top: 2px;
    }

    /* Stats Panel */
    .stats-panel {
      bottom: 30px;
      left: 20px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(51, 65, 85, 0.5);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      gap: 24px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #fff;
    }

    .stat-value.highlight {
      color: #6366f1;
    }

    .stat-label {
      font-size: 11px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Controls */
    .controls-panel {
      bottom: 30px;
      right: 20px;
      display: flex;
      gap: 8px;
    }

    .control-btn {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(51, 65, 85, 0.5);
      border-radius: 8px;
      padding: 10px 14px;
      color: #cbd5e1;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .control-btn:hover {
      border-color: rgba(99, 102, 241, 0.5);
      color: #fff;
    }

    .control-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Tooltip */
    .tooltip {
      position: fixed;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(99, 102, 241, 0.5);
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 13px;
      max-width: 280px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 200;
    }

    .tooltip.visible {
      opacity: 1;
    }

    .tooltip-title {
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }

    .tooltip-subtitle {
      font-size: 11px;
      color: #64748b;
    }

    .tooltip-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
      font-size: 12px;
      color: #6366f1;
    }

    /* Loading */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity 0.5s;
    }

    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 3px solid rgba(99, 102, 241, 0.2);
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Mobile */
    @media (max-width: 768px) {
      .header-title { font-size: 1.75rem; }
      .legend-panel { display: none; }
      .sector-panel { top: auto; bottom: 100px; right: 10px; left: 10px; flex-direction: row; flex-wrap: wrap; justify-content: center; }
      .sector-btn { padding: 8px 12px; font-size: 12px; }
      .stats-panel { left: 10px; right: 10px; justify-content: center; }
    }
  </style>
</head>
<body>
  <Navigation currentPage="visualizations" />

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading">
    <div class="loading-spinner"></div>
  </div>

  <!-- 3D Universe -->
  <div class="universe-container">
    <div id="universe-graph"></div>
  </div>

  <!-- Header -->
  <div class="overlay header-overlay">
    <div class="header-badge">
      <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064"></path>
      </svg>
      Placement Universe
      <span class="beta">Beta</span>
    </div>
    <h1 class="header-title">Placement Agent Universe</h1>
    <p class="header-subtitle">Explore the interconnected world of placement agents, PE firms, and deals</p>
  </div>

  <!-- Legend -->
  <div class="overlay legend-panel">
    <div class="legend-title">Node Types</div>
    <div class="legend-item">
      <div class="legend-dot" style="background: #6366f1;"></div>
      <span>Placement Agents</span>
    </div>
    <div class="legend-item">
      <div class="legend-dot" style="background: #10b981;"></div>
      <span>PE Firms</span>
    </div>
    <div class="legend-item">
      <div class="legend-dot" style="background: #f59e0b;"></div>
      <span>Deals/Events</span>
    </div>
    <div class="legend-item">
      <div class="legend-dot" style="background: #ef4444;"></div>
      <span>News</span>
    </div>

    <div class="legend-divider"></div>

    <div class="legend-title">Regions</div>
    <div class="legend-item">
      <div class="legend-dot" style="background: #3b82f6;"></div>
      <span>UK Market</span>
    </div>
    <div class="legend-item">
      <div class="legend-dot" style="background: #8b5cf6;"></div>
      <span>US Market</span>
    </div>
    <div class="legend-item">
      <div class="legend-dot" style="background: #06b6d4;"></div>
      <span>Europe</span>
    </div>
    <div class="legend-item">
      <div class="legend-dot" style="background: #ec4899;"></div>
      <span>Asia Pacific</span>
    </div>
  </div>

  <!-- Sector Filter -->
  <div class="overlay sector-panel" id="sector-panel">
    <button class="sector-btn active" data-sector="all">
      All Sectors
      <small>Full ecosystem view</small>
    </button>
    <a href="/ecosystem/uk" class="sector-btn">
      UK Market
      <small>British PE landscape</small>
    </a>
    <a href="/ecosystem/us" class="sector-btn">
      US Market
      <small>American PE landscape</small>
    </a>
    <a href="/ecosystem/private-credit" class="sector-btn">
      Private Credit
      <small>Debt & lending</small>
    </a>
    <a href="/ecosystem/real-estate" class="sector-btn">
      Real Estate PE
      <small>Property investments</small>
    </a>
  </div>

  <!-- Stats -->
  <div class="overlay stats-panel" id="stats-panel">
    <div class="stat-item">
      <div class="stat-value highlight" id="node-count">0</div>
      <div class="stat-label">Entities</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="edge-count">0</div>
      <div class="stat-label">Connections</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="agent-count">0</div>
      <div class="stat-label">Agents</div>
    </div>
  </div>

  <!-- Controls -->
  <div class="overlay controls-panel">
    <button class="control-btn" id="reset-camera">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
      </svg>
      Reset View
    </button>
    <a href="/deal-visualizations" class="control-btn">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
      </svg>
      Deal View
    </a>
  </div>

  <!-- Tooltip -->
  <div class="tooltip" id="tooltip">
    <div class="tooltip-title" id="tooltip-title"></div>
    <div class="tooltip-subtitle" id="tooltip-subtitle"></div>
    <div class="tooltip-link" id="tooltip-link">
      Click to explore
      <svg style="width: 12px; height: 12px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
      </svg>
    </div>
  </div>

  <script define:vars={{ companies, articles, sectors }}>
    const initUniverse = () => {
      const graphEl = document.getElementById('universe-graph');
      const loadingEl = document.getElementById('loading');
      const tooltipEl = document.getElementById('tooltip');
      const nodeCountEl = document.getElementById('node-count');
      const edgeCountEl = document.getElementById('edge-count');
      const agentCountEl = document.getElementById('agent-count');

      if (!graphEl || typeof ForceGraph3D === 'undefined') {
        setTimeout(initUniverse, 100);
        return;
      }

      // Build universe data
      const nodes = [];
      const links = [];

      // Region colors
      const regionColors = {
        'UK': '#3b82f6',
        'United Kingdom': '#3b82f6',
        'US': '#8b5cf6',
        'USA': '#8b5cf6',
        'United States': '#8b5cf6',
        'Europe': '#06b6d4',
        'Asia': '#ec4899',
        'Asia Pacific': '#ec4899'
      };

      // Type colors
      const typeColors = {
        'placement_agent': '#6366f1',
        'pe_firm': '#10b981',
        'deal': '#f59e0b',
        'news': '#ef4444'
      };

      // Add companies as nodes
      companies.forEach((company, i) => {
        const angle = (i / companies.length) * Math.PI * 2;
        const radius = 50 + Math.random() * 30;
        const height = (Math.random() - 0.5) * 40;

        // Determine color by type and region
        let color = typeColors[company.company_type] || '#64748b';
        const hq = company.headquarters || '';
        if (hq.includes('UK') || hq.includes('London')) color = regionColors['UK'];
        else if (hq.includes('US') || hq.includes('New York')) color = regionColors['US'];

        nodes.push({
          id: `company-${company.id}`,
          label: company.display_name || company.name,
          group: company.company_type,
          type: 'company',
          slug: company.slug,
          headquarters: company.headquarters,
          rank: company.global_rank,
          val: company.global_rank ? 20 - Math.min(company.global_rank, 15) : 8,
          color,
          fx: Math.cos(angle) * radius,
          fy: height,
          fz: Math.sin(angle) * radius
        });
      });

      // Add articles as deal/news nodes
      articles.forEach((article, i) => {
        const angle = Math.random() * Math.PI * 2;
        const radius = 80 + Math.random() * 20;
        const height = (Math.random() - 0.5) * 60;

        const isDeal = article.title?.match(/acqui|merger|buyout|investment|raises|funding|stake/i);

        nodes.push({
          id: `article-${article.id}`,
          label: article.title?.substring(0, 40) + '...',
          group: isDeal ? 'deal' : 'news',
          type: 'article',
          slug: article.slug,
          val: isDeal ? 6 : 4,
          color: isDeal ? typeColors.deal : typeColors.news,
          fx: Math.cos(angle) * radius,
          fy: height,
          fz: Math.sin(angle) * radius
        });
      });

      // Create links between nearby entities (simulating relationships)
      nodes.forEach((node, i) => {
        // Link companies to nearby articles
        if (node.type === 'company') {
          nodes.forEach((other, j) => {
            if (i !== j && other.type === 'article') {
              const dist = Math.sqrt(
                Math.pow(node.fx - other.fx, 2) +
                Math.pow(node.fy - other.fy, 2) +
                Math.pow(node.fz - other.fz, 2)
              );
              if (dist < 40) {
                links.push({
                  source: node.id,
                  target: other.id,
                  value: 0.3
                });
              }
            }
          });
        }

        // Link same-type companies
        if (node.type === 'company' && node.group === 'placement_agent') {
          nodes.forEach((other, j) => {
            if (i < j && other.type === 'company' && other.group === 'placement_agent') {
              const dist = Math.sqrt(
                Math.pow(node.fx - other.fx, 2) +
                Math.pow(node.fz - other.fz, 2)
              );
              if (dist < 30) {
                links.push({
                  source: node.id,
                  target: other.id,
                  value: 0.5
                });
              }
            }
          });
        }
      });

      // Update stats
      nodeCountEl.textContent = nodes.length;
      edgeCountEl.textContent = links.length;
      agentCountEl.textContent = sectors.placement_agents?.length || 0;

      // Create 3D graph
      const Graph = ForceGraph3D()
        (graphEl)
        .graphData({ nodes, links })
        .backgroundColor('#000')
        .nodeColor(node => node.color)
        .nodeVal(node => node.val)
        .nodeOpacity(0.9)
        .nodeRelSize(4)
        .linkColor(() => 'rgba(99, 102, 241, 0.15)')
        .linkWidth(0.5)
        .linkDirectionalParticles(link => link.value > 0.4 ? 1 : 0)
        .linkDirectionalParticleSpeed(0.002)
        .enableNodeDrag(false)
        .onNodeHover(node => {
          graphEl.style.cursor = node ? 'pointer' : 'default';

          if (node) {
            const screen = Graph.graph2ScreenCoords(node.x, node.y, node.z);
            tooltipEl.style.left = (screen.x + 20) + 'px';
            tooltipEl.style.top = (screen.y - 20) + 'px';
            document.getElementById('tooltip-title').textContent = node.label;
            document.getElementById('tooltip-subtitle').textContent =
              node.type === 'company' ? (node.headquarters || node.group) : node.group;
            tooltipEl.classList.add('visible');
          } else {
            tooltipEl.classList.remove('visible');
          }
        })
        .onNodeClick(node => {
          if (node && node.slug) {
            const url = node.type === 'company'
              ? `/private-equity-placement-agents-list/${node.slug}`
              : `/${node.slug}`;
            window.location.href = url;
          }
        });

      // Camera
      Graph.cameraPosition({ x: 150, y: 80, z: 150 }, { x: 0, y: 0, z: 0 }, 2000);

      // Rotation
      let angle = 0;
      let rotating = true;
      const animate = () => {
        if (rotating) {
          angle += 0.001;
          Graph.cameraPosition({
            x: Math.sin(angle) * 150,
            y: 60,
            z: Math.cos(angle) * 150
          });
        }
        requestAnimationFrame(animate);
      };
      setTimeout(animate, 3000);

      // Stop rotation on interaction
      graphEl.addEventListener('mousedown', () => { rotating = false; });
      graphEl.addEventListener('wheel', () => { rotating = false; });

      // Reset camera button
      document.getElementById('reset-camera')?.addEventListener('click', () => {
        rotating = true;
        angle = 0;
        Graph.cameraPosition({ x: 150, y: 80, z: 150 }, { x: 0, y: 0, z: 0 }, 1500);
      });

      // Hide loading
      setTimeout(() => {
        loadingEl.classList.add('hidden');
      }, 1500);
    };

    // Initialize when ready
    if (document.readyState === 'complete') {
      initUniverse();
    } else {
      window.addEventListener('load', initUniverse);
    }
  </script>
</body>
</html>
